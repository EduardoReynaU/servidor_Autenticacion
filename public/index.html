<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Login con GitHub</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    #profile { margin-top: 2rem; border: 1px solid #ccc; padding: 1rem; border-radius: 6px; width: fit-content; }
    img { width: 100px; border-radius: 50%; }
  </style>
</head>
<body>
  <h1>Bienvenido</h1>
  <button id="loginBtn">Iniciar sesión con GitHub</button>

  <div id="profile" style="display: none;">
    <h2>Perfil</h2>
    <p><strong>Usuario:</strong> <span id="username"></span></p>
    <p><strong>Email:</strong> <span id="email"></span></p>
    <p><strong>Proveedor:</strong> <span id="provider"></span></p>
    <p><strong>Tecnologías principales:</strong> <span id="langs"></span></p>
    <img id="avatar" alt="Avatar" />
    
  </div>

  <script>
    const CLIENT_ID = "Ov23li4LfuTmBBCacHIY"; // reemplaza con tu GitHub Client ID
    const REDIRECT_URI = "https://bc90-38-253-158-225.ngrok-free.app/callback";

    document.getElementById('loginBtn').onclick = () => {
      const githubUrl = `https://github.com/login/oauth/authorize?client_id=${CLIENT_ID}`;
      window.location.href = githubUrl;
    };

    async function exchangeCodeForUser(authCode) {
      const query = `
        mutation {
          loginWithGithub(authCode: "${authCode}") {
            id
            username
            email
            provider
            avatarUrl
          }
        }
      `;

      const response = await fetch("https://bc90-38-253-158-225.ngrok-free.app/graphql", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query })
      });

      const json = await response.json();
      return json.data.loginWithGithub;
    }

    async function handleLogin() {
      const urlParams = new URLSearchParams(window.location.search);
      const authCode = urlParams.get("code");

      if (!authCode) return;

      const user = await exchangeCodeForUser(authCode);

      if (user) {
        document.getElementById("loginBtn").style.display = "none";
        document.getElementById("profile").style.display = "block";
        document.getElementById("username").textContent = user.username;
        document.getElementById("email").textContent = user.email || "No disponible";
        document.getElementById("provider").textContent = user.provider;
        document.getElementById("avatar").src = user.avatarUrl;
        document.getElementById("langs").textContent = user.topLanguages.join(', ') || "No detectado";

      }
    }

    handleLogin();
  </script>
</body>
</html>
